@page "/review"

@attribute [Authorize]

<div class="heading">
   <h3>Обратная связь</h3>
   <p> <a href="home">Главная</a> / Оставить отзыв </p>
</div>

<section class="contact">
    @if (!_isBusy)
    {
        <EditForm Model="_request" OnValidSubmit="SubmitFormAsync">
            <DataAnnotationsValidator/>
            <h3>Оставьте ваш отзыв!</h3>
            <InputTextArea @bind-Value="_request.Content" name="message" class="box" placeholder="Текст отзыва" cols="30" rows="10"></InputTextArea>
            <div id="full-stars-example-two">
                <div class="rating-group">
                    <InputRadioGroup Name="Rating" @bind-Value="_request.Grade">
                        <InputRadio Value="0" disabled checked class="rating__input rating__input--none" id="rating3-none" type="radio"/>
                        <label aria-label="1 star" class="rating__label" for="rating3-1"><i class="rating__icon rating__icon--star fa fa-star"></i></label>
                        <InputRadio Value="1" class="rating__input" id="rating3-1" type="radio"/>
                        <label aria-label="2 stars" class="rating__label" for="rating3-2"><i class="rating__icon rating__icon--star fa fa-star"></i></label>
                        <InputRadio Value="2" class="rating__input" id="rating3-2" type="radio"/>
                        <label aria-label="3 stars" class="rating__label" for="rating3-3"><i class="rating__icon rating__icon--star fa fa-star"></i></label>
                        <InputRadio Value="3" class="rating__input" id="rating3-3" type="radio"/>
                        <label aria-label="4 stars" class="rating__label" for="rating3-4"><i class="rating__icon rating__icon--star fa fa-star"></i></label>
                        <InputRadio Value="4" class="rating__input" id="rating3-4" type="radio"/>
                        <label aria-label="5 stars" class="rating__label" for="rating3-5"><i class="rating__icon rating__icon--star fa fa-star"></i></label>
                        <InputRadio Value="5" class="rating__input" id="rating3-5" type="radio"/>
                    </InputRadioGroup>

                </div>
            </div>
            <input type="submit" value="Отправить" name="send-message" class="btn">
            <ValidationSummary/>
        </EditForm> 
    }
    else
    {
        <div style="display: flex; justify-content: center;">
            <div class="loader"></div>
        </div>
    }
    
</section>


@code {
    [Inject] IReviewManager ReviewManager { get; set; } = default!;
    [Inject] NavigationManager NavigationManager { get; set; } = default!;
    [Inject] IJSRuntime JsRuntime { get; set; } = default!;

    private bool _isBusy;
    private CreateReviewRequest _request = new();
    
    private async Task SubmitFormAsync()
    {
        try
        {
            _isBusy = true;

            var result = await ReviewManager.CreateAsync(_request);
            if (!result.Succeeded)
            {
                foreach (var message in result.Messages)
                    await JsRuntime.InvokeVoidAsync("alert", message);
                return;
            }
            foreach (var message in result.Messages)
                await JsRuntime.InvokeVoidAsync("alert", message);
            NavigationManager.NavigateTo(NavigationManager.BaseUri + "about", true,true);
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", ex.Message);
        }
        finally
        {
            _isBusy = false;
        }
    }
}